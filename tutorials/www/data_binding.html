<!--
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to you under the Apache License,
Version 2.0 (the "License"); you may not use this file except in
compliance with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html>
<head>
<title>Data Binding</title>
<link rel="stylesheet" href="tutorial.css">
<script src="http://java.com/js/deployJava.js"></script>

<!-- NOTE: Syntax highlighting script is LGPL -->
<script type="text/javascript" src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js"></script>
<script type="text/javascript" src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJava.js"></script>
<script type="text/javascript" src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushXml.js"></script>
<script type="text/javascript" src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJScript.js"></script>
<link type="text/css" rel="stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shCore.css"/>
<link type="text/css" rel="stylesheet" href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css"/>
<script type="text/javascript">
    SyntaxHighlighter.all();
</script>
</head>
<body>
<h1>Data Binding</h1>
<p>Data binding refers to the process of automatically populating or extracting data from a set of user interface elements. In Pivot, data binding is driven primarily by two methods of the <tt>Component</tt> class: <tt>load()</tt> and <tt>store()</tt>. Each method takes an instance of <tt>Dictionary&lt;String, ?&gt;</tt> called the "context". Calling <tt>load()</tt> causes data from the context to be "loaded" into the component; calling <tt>store()</tt> performs the reverse operation and "stores" data from the component into the context. Overloaded versions of both methods allow a caller to pass a JavaBean value as a bind context, which will be wrapped in a <tt>BeanDictionary</tt> and passed to the version that takes a dictionary argument. A third method, <tt>clear()</tt> allows a caller to reset any bindings.</p>

<p>The <tt>Container</tt> class overrides <tt>load()</tt> and <tt>store()</tt> to facilitate the use of nested contexts. When a container is assigned a context key, if a value with that key exists in the context passed to <tt>Container#load()</tt> or <tt>store()</tt>, that value becomes the context that is propagated to sub-components in further binds. This can significantly simplify the task of binding to complex data structures.</p>

<p>The following application demonstrates data binding. It allows the user to load a form with address data either from a JSON file or from a JavaBean object, as well as clear the form:</p>

<script src="version.js"></script>
<script>
var attributes = {code:"org.apache.pivot.wtk.BrowserApplicationContext$HostApplet",
    archive:"lib/pivot-core-" + version + ".jar"
        + ",lib/pivot-wtk-" + version + ".jar"
        + ",lib/pivot-wtk-" + version + ".terra.jar"
        + ",lib/pivot-tutorials-" + version + ".jar",
    width:250,
    height:230
};
var parameters = {application_class_name:"org.apache.pivot.tutorials.databinding.DataBinding",
    codebase_lookup:false,
    java_arguments:"-Dsun.awt.noerasebackground=true -Dsun.awt.erasebackgroundonresize=true"
};
deployJava.writeAppletTag(attributes, parameters);
</script>

<p>The WTKX simply sets up the form structure and the bind keys:</p>

<pre class="brush:xml">
&lt;Window title="Data Binding" maximized="true"
    xmlns:wtkx="http://pivot.apache.org/wtkx"
    xmlns="org.apache.pivot.wtk"&gt;
    &lt;content&gt;
        &lt;Border styles="{padding:6}"&gt;
            &lt;content&gt;
                &lt;BoxPane orientation="vertical" styles="{spacing:10, fill:true}"&gt;
                    &lt;Form wtkx:id="form"&gt;
                        &lt;sections&gt;
                            &lt;Form.Section&gt;
                                &lt;Label wtkx:id="sourceLabel" Form.label="Source" styles="{font:{italic:true}}"/&gt;

                                &lt;Label Form.label="ID" textKey="id"/&gt;
                                &lt;Label Form.label="Name" textKey="name"/&gt;

                                &lt;BoxPane Form.label="Address" orientation="vertical" contextKey="address"&gt;
                                    &lt;Label textKey="street"/&gt;
                                    &lt;BoxPane&gt;
                                        &lt;Label textKey="city"/&gt;
                                        &lt;Label textKey="state"/&gt;
                                        &lt;Label textKey="zip"/&gt;
                                    &lt;/BoxPane&gt;
                                &lt;/BoxPane&gt;

                                &lt;Label Form.label="Phone" textKey="phoneNumber"/&gt;
                                &lt;Label Form.label="Email" textKey="emailAddress"/&gt;

                                &lt;BoxPane Form.label="IM"&gt;
                                    &lt;Label textKey="imAccount.id"/&gt;
                                    &lt;Label textKey="imAccount.id"/&gt;
                                &lt;/BoxPane&gt;
                            &lt;/Form.Section&gt;
                        &lt;/sections&gt;
                    &lt;/Form&gt;

                    &lt;Separator/&gt;

                    &lt;BoxPane styles="{horizontalAlignment:'right'}"&gt;
                        &lt;PushButton wtkx:id="loadJSONButton" buttonData="Load JSON"/&gt;
                        &lt;PushButton wtkx:id="loadJavaButton" buttonData="Load Java"/&gt;
                        &lt;PushButton wtkx:id="clearButton" buttonData="Clear"/&gt;
                    &lt;/BoxPane&gt;
                &lt;/BoxPane&gt;
            &lt;/content&gt;
        &lt;/Border&gt;
    &lt;/content&gt;
&lt;/Window&gt;
</pre>

<p>Note that the <tt>&lt;BoxPane&gt;</tt> for the address section defines a context key. This creates a nested bind context for its sub-elements, allowing the sub-elements to refer to the bound values using a relative key (e.g. "street"). However, since the <tt>&lt;BoxPane&gt;</tt> for the IM account section does not define a context key, its sub-elements must refer to their bound values using a path that is relative to the root context (e.g. "imAccount.id").</p>

<p>The application's <tt>startup()</tt> method defines the button press listeners that load or clear the form:</p>

<pre class="brush:java">
package org.apache.pivot.tutorials.databinding;

import java.io.InputStream;

import org.apache.pivot.collections.Map;
import org.apache.pivot.serialization.JSONSerializer;
import org.apache.pivot.wtk.Application;
import org.apache.pivot.wtk.Button;
import org.apache.pivot.wtk.ButtonPressListener;
import org.apache.pivot.wtk.DesktopApplicationContext;
import org.apache.pivot.wtk.Display;
import org.apache.pivot.wtk.Form;
import org.apache.pivot.wtk.Label;
import org.apache.pivot.wtk.PushButton;
import org.apache.pivot.wtk.Window;
import org.apache.pivot.wtkx.WTKXSerializer;

public class DataBinding implements Application {
    private Window window = null;
    private Form form = null;
    private PushButton loadJavaButton = null;
    private PushButton loadJSONButton = null;
    private PushButton clearButton = null;
    private Label sourceLabel = null;

    private static final Contact CONTACT = new Contact("101", "Joe User",
        new Address("123 Main St.", "Cambridge", "MA", "02142"),
        "(617) 555-1234", "joe_user@foo.com",
        new IMAccount("juser1234", "AIM"));

    @Override
    public void startup(Display display, Map&lt;String, String&gt; properties)
        throws Exception {
        WTKXSerializer wtkxSerializer = new WTKXSerializer();
        window = (Window)wtkxSerializer.readObject(this, "data_binding.wtkx");
        form = (Form)wtkxSerializer.get("form");
        loadJavaButton = (PushButton)wtkxSerializer.get("loadJavaButton");
        loadJSONButton = (PushButton)wtkxSerializer.get("loadJSONButton");
        clearButton = (PushButton)wtkxSerializer.get("clearButton");
        sourceLabel = (Label)wtkxSerializer.get("sourceLabel");

        loadJavaButton.getButtonPressListeners().add(new ButtonPressListener() {
            @Override
            public void buttonPressed(Button button) {
                form.load(CONTACT);
                sourceLabel.setText("Java");
            }
        });

        loadJSONButton.getButtonPressListeners().add(new ButtonPressListener() {
            @SuppressWarnings("unchecked")
            @Override
            public void buttonPressed(Button button) {
                JSONSerializer serializer = new JSONSerializer();
                InputStream inputStream = getClass().getResourceAsStream("contact.json");

                try {
                    form.load((Map&lt;String, Object&gt;)serializer.readObject(inputStream));
                    sourceLabel.setText("JSON");
                } catch(Exception exception) {
                    System.err.println(exception);
                }

                button.setEnabled(true);
            }
        });

        clearButton.getButtonPressListeners().add(new ButtonPressListener() {
            @Override
            public void buttonPressed(Button button) {
                form.clear();
                sourceLabel.setText(null);
            }
        });

        window.open(display);
    }

    @Override
    public boolean shutdown(boolean optional) {
        if (window != null) {
            window.close();
        }

        return false;
    }


    @Override
    public void suspend() {
    }

    @Override
    public void resume() {
    }

    public static void main(String[] args) {
        DesktopApplicationContext.main(DataBinding.class, args);
    }
}
</pre>

<p>The JSON representation of the sample contact record is defined as follows (note that, while JSON is used to represent the data in this example, any class that implements the <tt>Dictionary</tt> interface, including <tt>HashMap</tt>, can be used):</p>

<pre class="brush:javascript">
{   id: 101,
    name: "Joe User",

    address: {
        street: "123 Main St.",
        city: "Cambridge",
        state: "MA",
        zip: "02142"
    },

    phoneNumber: "(617) 555-1234",
    emailAddress: "joe_user@foo.com",

    imAccount: {
        id: "juser1234",
        type: "AIM"
    }
}
</pre>

<p>The JavaBean version, which represents the same data, is composed of the following classes:</p>

<pre class="brush:java">
package org.apache.pivot.tutorials.databinding;

public class Contact {
    private String id;
    private String name;
    private Address address;
    private String phoneNumber;
    private String emailAddress;
    private IMAccount imAccount;

    public Contact(String id, String name, Address address, String phoneNumber,
        String emailAddress, IMAccount imAccount) {
        this.id = id;
        this.name = name;
        this.address = address;
        this.phoneNumber = phoneNumber;
        this.emailAddress = emailAddress;
        this.imAccount = imAccount;
    }

    public String getID() {
        return id;
    }

    public String getId() {
        return getID();
    }

    public String getName() {
        return name;
    }

    public Address getAddress() {
        return address;
    }

    public String getPhoneNumber() {
        return phoneNumber;
    }

    public String getEmailAddress() {
        return emailAddress;
    }

    public IMAccount getIMAccount() {
        return imAccount;
    }

    public IMAccount getImAccount() {
        return getIMAccount();
    }
}
</pre>
<p class="caption">Contact.java</p>

<pre class="brush:java">
package org.apache.pivot.tutorials.databinding;

public class Address {
    private String street;
    private String city;
    private String state;
    private String zip;

    public Address() {
        this(null, null, null, null);
    }

    public Address(String street, String city, String state, String zip) {
        this.street = street;
        this.city = city;
        this.state = state;
        this.zip = zip;
    }

    public String getStreet() {
        return street;
    }

    public String getCity() {
        return city;
    }

    public String getState() {
        return state;
    }

    public String getZip() {
        return zip;
    }
}
</pre>
<p class="caption">Address.java</p>

<pre class="brush:java">
package org.apache.pivot.tutorials.databinding;

public class IMAccount {
    private String id;
    private String type;

    public IMAccount() {
        this(null, null);
    }

    public IMAccount(String id, String type) {
        this.id = id;
        this.type = type;
    }

    public String getID() {
        return id;
    }

    public String getId() {
        return getID();
    }

    public String getType() {
        return type;
    }
}
</pre>
<p class="caption">IMAccount.java</p>

<p>Next: <a href="localization.html">Localization</a></p>
</body>
</html>
